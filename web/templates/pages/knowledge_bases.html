{{define "content"}}
{{template "navbar" .}}
<main class="container">
    <div class="page-header">
        <h1>Knowledge Bases</h1>
        <p>Manage knowledge bases for AI agents to reference during calls.</p>
    </div>

    {{if .Error}}
    <div class="alert alert-error">{{.Error}}</div>
    {{end}}

    {{if .Success}}
    <div class="alert alert-success">Knowledge base saved successfully!</div>
    {{end}}

    <div class="knowledge-layout">
        <section class="card knowledge-create">
            <div class="card-header">
                <h3>Create Knowledge Base</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="/knowledge-bases/create" class="kb-form">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="name" name="name" required placeholder="e.g., Project FAQs, Pricing Info, Tech Stack">
                        <small>A descriptive name for this knowledge base</small>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" id="description" name="description" placeholder="e.g., Common questions about web development projects">
                        <small>Helps the AI understand when to use this knowledge</small>
                    </div>

                    <div class="form-group">
                        <label for="text">Content</label>
                        <textarea id="text" name="text" rows="10" required placeholder="Enter the knowledge content that should be searchable."></textarea>
                        <small>The text content that will be vectorized for retrieval</small>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn">Create Knowledge Base</button>
                    </div>
                </form>
            </div>
        </section>

        <section class="knowledge-list">
            <div class="list-header">
                <h3>Existing Knowledge Bases ({{len .KnowledgeBases}})</h3>
            </div>

            {{if .KnowledgeBases}}
            <div class="kb-grid">
                {{range .KnowledgeBases}}
                <article class="kb-card">
                    <div class="kb-header">
                        <h4>{{.Name}}</h4>
                        <span class="kb-id" title="Vector ID">{{.VectorID}}</span>
                    </div>
                    {{if .Description}}
                    <p class="kb-description">{{.Description}}</p>
                    {{end}}
                    <div class="kb-meta">
                        {{if not .CreatedAt.IsZero}}
                        <span class="meta-item">
                            <span class="meta-label">Created:</span> {{formatDate .CreatedAt}}
                        </span>
                        {{end}}
                        {{if not .UpdatedAt.IsZero}}
                        <span class="meta-item">
                            <span class="meta-label">Updated:</span> {{formatDate .UpdatedAt}}
                        </span>
                        {{end}}
                    </div>
                    <div class="kb-actions">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="viewKnowledgeBase('{{.VectorID}}', '{{.Name}}')">View</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="editKnowledgeBase('{{.VectorID}}', '{{.Name}}', '{{.Description}}')">Edit</button>
                        <form method="POST" action="/knowledge-bases/delete/{{.VectorID}}"
                              onsubmit="return confirm('Are you sure you want to delete this knowledge base?')">
                            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </div>
                </article>
                {{end}}
            </div>
            {{else}}
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“š</div>
                <h3>No Knowledge Bases Yet</h3>
                <p>Create your first knowledge base to give agents more context during calls.</p>
            </div>
            {{end}}
        </section>
    </div>
</main>

<!-- View Modal -->
<div id="viewModal" class="modal-backdrop is-hidden">
    <div class="modal modal-lg" role="dialog" aria-modal="true" aria-labelledby="viewModalTitle">
        <div class="modal-header">
            <h3 id="viewModalTitle">Knowledge Base Content</h3>
            <button type="button" class="modal-close" aria-label="Close" onclick="hideModal('viewModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="viewModalContent" class="kb-content-view">
                Loading...
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="hideModal('viewModal')">Close</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-backdrop is-hidden">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="modal-header">
            <h3 id="editModalTitle">Edit Knowledge Base</h3>
            <button type="button" class="modal-close" aria-label="Close" onclick="hideModal('editModal')">&times;</button>
        </div>
        <form method="POST" action="/knowledge-bases/update" id="editForm">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <input type="hidden" name="vector_id" id="editVectorId">
            <div class="modal-body">
                <div class="form-group">
                    <label for="editName">Name</label>
                    <input type="text" id="editName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <input type="text" id="editDescription" name="description">
                </div>
                <div class="form-group">
                    <label for="editText">Additional Content (append)</label>
                    <textarea id="editText" name="text" rows="6" placeholder="Enter additional content to append to this knowledge base"></textarea>
                    <small>Leave empty to only update name/description</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal('editModal')">Cancel</button>
                <button type="submit" class="btn">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
function showModal(id) {
    var modal = document.getElementById(id);
    modal.classList.remove('is-hidden');
    modal.setAttribute('aria-hidden', 'false');
}

function hideModal(id) {
    var modal = document.getElementById(id);
    modal.classList.add('is-hidden');
    modal.setAttribute('aria-hidden', 'true');
}

function viewKnowledgeBase(vectorId, name) {
    document.getElementById('viewModalTitle').textContent = name;
    document.getElementById('viewModalContent').textContent = 'Loading content...';
    showModal('viewModal');

    fetch('/knowledge-bases/content/' + vectorId)
        .then(function(response) { return response.text(); })
        .then(function(content) {
            document.getElementById('viewModalContent').textContent = content || 'No content available';
        })
        .catch(function() {
            document.getElementById('viewModalContent').textContent = 'Failed to load content';
        });
}

function editKnowledgeBase(vectorId, name, description) {
    document.getElementById('editVectorId').value = vectorId;
    document.getElementById('editName').value = name;
    document.getElementById('editDescription').value = description || '';
    document.getElementById('editText').value = '';
    showModal('editModal');
}

document.addEventListener('click', function(e) {
    var backdrop = e.target.closest('.modal-backdrop');
    if (backdrop && e.target === backdrop) {
        hideModal(backdrop.id);
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-backdrop').forEach(function(backdrop) {
            if (!backdrop.classList.contains('is-hidden')) {
                hideModal(backdrop.id);
            }
        });
    }
});
</script>
{{end}}
