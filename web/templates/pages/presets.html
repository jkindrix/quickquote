{{define "head"}}
<script>
    document.addEventListener('htmx:configRequest', function(evt) {
        evt.detail.headers['X-CSRF-Token'] = getCsrfToken();
    });
    function getCsrfToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrf_token') return value;
        }
        return '';
    }
    function confirmDelete(presetName) {
        return confirm('Delete preset "' + presetName + '"? This cannot be undone.');
    }
    function showCreateModal() {
        document.getElementById('createModal').style.display = 'flex';
    }
    function hideCreateModal() {
        document.getElementById('createModal').style.display = 'none';
    }
    function showApplyModal(presetId, presetName) {
        document.getElementById('applyPresetId').value = presetId;
        document.getElementById('applyPresetName').textContent = presetName;
        document.getElementById('applyModal').style.display = 'flex';
    }
    function hideApplyModal() {
        document.getElementById('applyModal').style.display = 'none';
    }
</script>
{{end}}

{{define "content"}}
{{template "navbar" .}}
<main class="container">
    <div class="page-header">
        <h1>Conversation Presets</h1>
        <p>Manage AI agent configurations for your inbound calls</p>
    </div>

    {{if .Success}}
    <div class="alert alert-success">{{.SuccessMessage}}</div>
    {{end}}
    {{if .Error}}
    <div class="alert alert-error">{{.Error}}</div>
    {{end}}

    <div class="action-bar">
        <div class="action-bar-left">
            <span>{{.TotalPresets}} preset{{if ne .TotalPresets 1}}s{{end}}</span>
        </div>
        <button class="btn" onclick="showCreateModal()">Create Preset</button>
    </div>

    {{if .Presets}}
    <div class="presets-grid">
        {{range .Presets}}
        <div class="card preset-card {{if .IsDefault}}preset-default{{end}}">
            <div class="preset-header">
                <div>
                    <h3 class="preset-name">{{.Name}}</h3>
                    {{if .IsDefault}}<span class="status status-completed">Default</span>{{end}}
                    {{if not .IsActive}}<span class="status status-pending">Inactive</span>{{end}}
                </div>
                <div class="preset-voice">
                    <span class="voice-tag">{{.Voice}}</span>
                </div>
            </div>

            {{if .Description}}
            <p class="preset-description">{{.Description}}</p>
            {{end}}

            <div class="preset-details">
                <div class="detail-row">
                    <span class="detail-label">Temperature</span>
                    <span class="detail-value">{{if .Temperature}}{{printf "%.1f" .Temperature}}{{else}}0.7{{end}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Interruption</span>
                    <span class="detail-value">{{if .InterruptionThreshold}}{{.InterruptionThreshold}}ms{{else}}100ms{{end}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Max Duration</span>
                    <span class="detail-value">{{if .MaxDuration}}{{.MaxDuration}}min{{else}}15min{{end}}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Language</span>
                    <span class="detail-value">{{if .Language}}{{.Language}}{{else}}en-US{{end}}</span>
                </div>
            </div>

            <div class="preset-task">
                <strong>Task Preview:</strong>
                <p class="task-preview">{{truncate .Task 150}}</p>
            </div>

            <div class="preset-actions">
                <button class="btn btn-sm" onclick="showApplyModal('{{.ID}}', '{{.Name}}')">Apply to Number</button>
                {{if not .IsDefault}}
                <form method="POST" action="/presets/{{.ID}}/default" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                    <button type="submit" class="btn btn-sm btn-secondary">Set Default</button>
                </form>
                {{end}}
                <a href="/presets/{{.ID}}/edit" class="btn btn-sm btn-secondary">Edit</a>
                {{if not .IsDefault}}
                <form method="POST" action="/presets/{{.ID}}/delete" style="display: inline;" onsubmit="return confirmDelete('{{.Name}}');">
                    <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <div class="card">
        <div class="empty-state">
            <div class="empty-state-icon">ðŸ“‹</div>
            <h3>No Presets Yet</h3>
            <p>Create your first conversation preset to configure how the AI agent handles calls.</p>
            <button class="btn" onclick="showCreateModal()">Create Preset</button>
        </div>
    </div>
    {{end}}
</main>

<!-- Create Preset Modal -->
<div id="createModal" class="modal-backdrop" style="display: none;">
    <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
            <h2>Create Preset</h2>
            <button class="modal-close" onclick="hideCreateModal()">&times;</button>
        </div>
        <form method="POST" action="/presets/create">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

            <div class="form-group">
                <label for="name">Preset Name *</label>
                <input type="text" id="name" name="name" required placeholder="e.g., Software Project Intake">
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" id="description" name="description" placeholder="Brief description of this preset's purpose">
            </div>

            <div class="form-group">
                <label for="task">Agent Task / Prompt *</label>
                <textarea id="task" name="task" required style="min-height: 200px;" placeholder="You are Alex, a friendly project consultant at QuickQuote. Your goal is to have a natural conversation to understand the caller's software project needs..."></textarea>
                <span class="form-hint">Instructions for how the AI agent should behave during calls</span>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="voice">Voice</label>
                    <select id="voice" name="voice">
                        <option value="mason">Mason (Male, Professional)</option>
                        <option value="maya">Maya (Female, Warm)</option>
                        <option value="matt">Matt (Male, Friendly)</option>
                        <option value="evelyn">Evelyn (Female, Calm)</option>
                        <option value="josh">Josh (Male, Energetic)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="language">Language</label>
                    <select id="language" name="language">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="temperature">Temperature (0-1)</label>
                    <input type="number" id="temperature" name="temperature" value="0.4" min="0" max="1" step="0.1">
                    <span class="form-hint">Lower = more consistent, Higher = more creative</span>
                </div>
                <div class="form-group">
                    <label for="interruption_threshold">Interruption Threshold (ms)</label>
                    <input type="number" id="interruption_threshold" name="interruption_threshold" value="180" min="50" max="500">
                    <span class="form-hint">Higher = waits longer before responding</span>
                </div>
            </div>

            <div class="form-group">
                <label for="first_sentence">First Sentence</label>
                <input type="text" id="first_sentence" name="first_sentence" placeholder="Hello! Thanks for calling QuickQuote...">
                <span class="form-hint">What the AI says when answering the call</span>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="max_duration">Max Duration (minutes)</label>
                    <input type="number" id="max_duration" name="max_duration" value="15" min="1" max="60">
                </div>
                <div class="form-group">
                    <label for="model">AI Model</label>
                    <select id="model" name="model">
                        <option value="enhanced">Enhanced (Recommended)</option>
                        <option value="base">Base (Faster)</option>
                    </select>
                </div>
            </div>

            <div class="toggle-group">
                <div class="toggle-label">
                    <span>Wait for Greeting</span>
                    <span>Agent waits for caller to speak first</span>
                </div>
                <label class="toggle">
                    <input type="checkbox" name="wait_for_greeting" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-group">
                <div class="toggle-label">
                    <span>Noise Cancellation</span>
                    <span>Filter background noise</span>
                </div>
                <label class="toggle">
                    <input type="checkbox" name="noise_cancellation" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-group">
                <div class="toggle-label">
                    <span>Record Calls</span>
                    <span>Record for review and quality assurance</span>
                </div>
                <label class="toggle">
                    <input type="checkbox" name="record" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCreateModal()">Cancel</button>
                <button type="submit" class="btn">Create Preset</button>
            </div>
        </form>
    </div>
</div>

<!-- Apply to Number Modal -->
<div id="applyModal" class="modal-backdrop" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2>Apply Preset to Phone Number</h2>
            <button class="modal-close" onclick="hideApplyModal()">&times;</button>
        </div>
        <form method="POST" action="/presets/apply">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <input type="hidden" id="applyPresetId" name="preset_id" value="">

            <p>Apply preset "<strong id="applyPresetName"></strong>" to:</p>

            <div class="form-group">
                <label for="phone_number">Phone Number</label>
                <select id="phone_number" name="phone_number" required>
                    {{range .PhoneNumbers}}
                    <option value="{{.PhoneNumber}}">{{.PhoneNumber}}</option>
                    {{else}}
                    <option value="+14154834051">+14154834051</option>
                    {{end}}
                </select>
                <span class="form-hint">Select the inbound number to apply this preset to</span>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideApplyModal()">Cancel</button>
                <button type="submit" class="btn btn-success">Apply Preset</button>
            </div>
        </form>
    </div>
</div>

<style>
.presets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
}

.preset-card {
    display: flex;
    flex-direction: column;
}

.preset-card.preset-default {
    border: 2px solid #007bff;
}

.preset-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.preset-name {
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
}

.preset-description {
    color: #666;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.preset-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 4px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
}

.detail-label {
    color: #666;
    font-size: 0.75rem;
}

.detail-value {
    font-weight: 500;
    font-size: 0.875rem;
}

.preset-task {
    margin-bottom: 1rem;
    flex-grow: 1;
}

.preset-task strong {
    font-size: 0.75rem;
    color: #666;
    text-transform: uppercase;
}

.task-preview {
    font-size: 0.875rem;
    color: #333;
    margin-top: 0.25rem;
    line-height: 1.4;
}

.preset-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    padding-top: 1rem;
    border-top: 1px solid #eee;
}

@media (max-width: 768px) {
    .presets-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{{end}}
